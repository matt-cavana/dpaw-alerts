@model IEnumerable<dpaw_alerts.Models.Park>

@{
    ViewBag.Title = "Index";
}

<div id="breadcrumb">
    <ul class="breadcrumb">
        <li><i class="fa fa-home"></i><a href="~/Home"> Home</a></li>

        <li class="active">Parks</li>
    </ul>
</div><!-- /breadcrumb-->
<div class="main-header clearfix">
    <div class="page-title">
        <h3 class="no-margin">Parks List</h3>
        <span>Department of Parks and Wildlife parks list</span>
    </div><!-- /page-title -->

</div><!-- /main-header -->

<div class="row padding-md">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3>   &nbsp; @Html.ActionLink("Create Park", "Create", null, new { @class = "btn btn-sm btn-info" })</h3>
            
        </div>
      
        <div class="panel-body">
            @if (TempData["Message"] != null)
            {
                <div class="alert alert-success" id="msg">
                    <i class="glyphicon glyphicon-info-sign"></i>   @TempData["Message"]
                </div>
            }
            <p>Displaying list of parks recorded in the system. Please make sure the GPS location match with RecData or Explore Parks website when creating a new park manually.</p>
           
            <div class="panel-tab clearfix">
                <ul class="tab-bar tab-primary">
                    <li class="active"><a href="#home1" data-toggle="tab"><i class="fa fa-list-alt"></i> List</a></li>
                    
                    <li><a href="#mapview" data-toggle="tab" id="gmap"><i class="fa fa-map"></i> Alt Map</a></li>
                </ul>
            </div>
            
            <div class="tab-content">
                <div class="tab-pane fade in active" id="home1">
                    <table class="table table-striped table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>
                                    PID#
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.Name)
                                </th>
                               
                                <th>
                                    @Html.DisplayNameFor(model => model.District)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.Tenure)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.Longitude)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.Latitude)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.Contact.OfficeName)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.Status)
                                </th>
                                <th width="220">
                                   Author
                                </th>
                                
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @{int rowNo = 0;}
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td> @(rowNo += 1)</td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.RPrkId)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Name)
                                    </td>
                                    
                                    <td>
                                        @Html.DisplayFor(modelItem => item.District)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Tenure)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Longitude)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Latitude)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Contact.OfficeName) <a href="#contactInfo" role="button" data-toggle="modal" class="contact" data-value="@item.ContactId" > <i class="fa fa-info-circle blue"></i> </a> 
                                    </td>
                                    <td>
                                      @if (item.Status == "Active")
                                      {
                                        <i class="fa fa-circle green" title="Active"></i>
                                      }
                                      else
                                      {
                                        <i class="fa fa-circle red" title="Inactive"></i>
                                      } 
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            <i class="fa fa-user-circle-o purple"></i>
                                            @Html.DisplayFor(modelItem => item.CreatedBy)
                                            <i class="fa fa-calendar-check-o green"></i>     @Html.DisplayFor(modelItem => item.CreateDate) <br />
                                           
                                        </small>
                                        
                                        
                                    </td>
                                    
                                    <td width="160">
                                        <div class="btn-group-xs">
                                            <a href="#parkInfo" role="button" data-toggle="modal" class="btn btn-info btn-sm park" data-value="@item.ParkId">  Details </a> 
                                            @Html.ActionLink("Edit", "Edit", new { id = item.ParkId }, new { @class = "btn btn-sm btn-success" }) 
                                            
                                            <input type="button" value="Delete" class="btn btn-danger delete" data-value="@item.ParkId" />
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>
              
                <div class="tab-pane fade" id="mapview">

                   
                    <br />
                    <div class="loadingOverlay" >
                        <div class="loading-spinner">
                            <img src="~/img/loading.png" title="Loading" />
                            <span class="loading-text">Loading...</span>
                        </div>
                    </div>
                    <!-- This is the div that will contain the Google Map -->
                    <div id="map_canvas" style="height: 550px;"> </div>

                </div>
            </div>
        </div>
    </div><!-- /panel -->
</div>
<!--Modal-->
<div class="modal fade" id="contactInfo">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4>Contact Information</h4>
            </div>
            <div class="modal-body">
                <div id="contact"> <center> <img src="~/img/loading.png" /> <br /> Loading ... </center></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-success" data-dismiss="modal" aria-hidden="true">Close</button>
                
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--Modal-->
<div class="modal fade" id="parkInfo">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4>Park Information</h4>
            </div>
            <div class="modal-body">
                <div id="parkContent"><center> <img src="~/img/loading.png" /> <br /> Loading ... </center></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-success" data-dismiss="modal" aria-hidden="true">Close</button>

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaJlkDXFC39cH9PQo7j3C9RmUAFkXAEQY"> </script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/jquery-ui.min.js"></script>

@section scripts
{
    <script>

        $(function () {

            /*
            $('#chk-all').click(function()	{
                if($(this).is(':checked'))	{
                    $('#responsiveTable').find('.chk-row').each(function()	{
                        $(this).prop('checked', true);
                        $(this).parent().parent().parent().addClass('selected');
                    });
                }
                else	{
                    $('#responsiveTable').find('.chk-row').each(function()	{
                        $(this).prop('checked' , false);
                        $(this).parent().parent().parent().removeClass('selected');
                    });
                }
            });
            */


            $(".delete").click(function (e) {

                if (confirm('Are you sure want to delete?')) {
                    e.preventDefault();
                    var parent = $(this).parent().parent().parent();

                    {

                        $.ajax({
                            url: '@Url.Action("AjaxDelete", "Parks")',
                            type: 'POST',
                            dataType: 'json',
                            async: true,
                            data: { 'parkId': $(this).attr('data-value') },
                            contentType: 'application/x-www-form-urlencoded',
                            beforeSend: function () {
                                parent.animate({ 'backgroundColor': '#fb6c6c' }, 300);
                            },
                            success: function (data) {
                                if (data.success) {

                                    $("#msg").html("<div class='alert alert-success'>The user has been deleted from the system! </div>");

                                    parent.slideUp(300, function () {
                                        parent.remove();
                                    });

                                }
                                else {
                                    // show a message in a alert or div
                                    $("#msg").html("<div class='alert alert-danger'>Sorry, the user cannot be deleted! </div>");
                                }
                            }
                        });
                    }
                }
                else return false;
            });

            //call the set map event
            //  Initialize();

            $(".contact").click(function (e) {

                var id = $(this).attr("data-value");
                var url = '@(Url.Action("AjaxDetails", "Contacts"))/' + id;
                //  alert(id);

                $("#contact").load(url);

            });

            $(".park").click(function (e) {

                var id = $(this).attr("data-value");
                var url = '@(Url.Action("Details", "Parks"))/' + id;
                //  alert(id);

                $("#parkContent").load(url);

            });


            //set the data table
            $('#dataTable').dataTable({
                "bJQueryUI": true,
                "sPaginationType": "full_numbers",
                // "bSort" : false,
                "aaSorting": [[2, "asc"]],
                "aoColumnDefs": [
                                { "bSortable": false, "aTargets": [10] }
                ]


            });


            var myVar;

            $("#gmap").click(function (e) {
                // $(".loading-spinner").show();

                Initialize();
                //resetMap(map);
               // google.maps.event.trigger(map, 'resize');

                myVar = setTimeout(function () { Initialize(); }, 300);

            });

            function myStopFunction() {
                clearTimeout(myVar);
            }


        // Where all the fun happens
        function Initialize() {

            // Google has tweaked their interface somewhat - this tells the api to use that new UI
            google.maps.visualRefresh = true;
            var Tunisie = new google.maps.LatLng(-30.81881, 116.16596);

            // These are options that set initial zoom level, where the map is centered globally to start, and the type of map to show
            var mapOptions = {
                zoom: 6,
                center: Tunisie,
                mapTypeId: google.maps.MapTypeId.G_NORMAL_MAP
            };

            // This makes the div with id "map_canvas" a google map
            var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

            // put in some information about each json object - in this case, the opening hours.
            var infowindow;
            $.ajax({
                type: "GET",
                url: '@Url.Action("map", "Parks")',
                dataType: 'json',
                contentType: 'application/x-www-form-urlencoded',
                success: function (data) {
                    //  data1 = JSON.stringify(data);
                    // $("#data").html(data1);
                    $.each(data, function (i, item) {
                        // alert(item.Longitude);
                        var marker = new google.maps.Marker({
                            'position': new google.maps.LatLng(item.Latitude, item.Longitude),
                            'map': map,
                            'title': item.Name

                        });

                        // Make the marker-pin blue!
                       marker.setIcon('https://maps.google.com/mapfiles/ms/icons/blue-dot.png')

                        // finally hook up an "OnClick" listener to the map so it pops up out info-window when the marker-pin is clicked!
                        google.maps.event.addListener(marker, 'click', function () {

                            if (infowindow) infowindow.close();
                            infowindow = new google.maps.InfoWindow({ content: "<div class='infoDiv'><h3>" + item.Name + "</h3>" + item.Description + "</div>" });

                            infowindow.open(map, marker);
                        });
                    });

                }

            })
            .done(function () {
                $(".loadingOverlay").hide();
            });

        }

        });

       
    </script>

}

